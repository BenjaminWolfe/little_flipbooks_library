<!DOCTYPE html>
<html>
  <head>
    <title>Proposed code parsing for flipbooks</title>
    <meta charset="utf-8">
    <meta name="author" content="Gina Reynolds, May 2019" />
    <link href="libs/remark-css-0.0.1/kunoichi.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/ninjutsu.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Proposed code parsing for flipbooks
### Gina Reynolds, May 2019

---



# Parse code



```r
parse_code &lt;- function(code) { 
  
  tibble(code = code) %&gt;% 
    mutate(user_reveal = str_detect(code, "#REVEAL")) %&gt;% # Handle user defined pause points
    mutate(code = str_remove(code, "#REVEAL")) %&gt;% # pull out any comments
    separate(col = code, into = c("code", "comment"), sep = "#") %&gt;% 
    mutate(comment = str_trim(comment)) %&gt;% 
    mutate(comment = paste0("  # ", comment)) %&gt;%  
    mutate(comment = ifelse("  # NA" == comment, "", comment)) %&gt;% 
    mutate(code = str_remove(code, "\\s+$")) %&gt;% 
    mutate(connector = str_extract(code, "%&gt;%$|\\+$|-&gt;$")) %&gt;% 
    mutate(connector = replace_na(connector, "")) %&gt;% 
    mutate(code = str_remove(code, "%&gt;%$|\\+$|-&gt;$")) %&gt;% 
    mutate(num_open_par = str_count(code, "\\(|\\{|\\[")) %&gt;% # Counting open parentheses
    mutate(num_closed_par = str_count(code, "\\)|\\}|\\]")) %&gt;%  # Counting closed parentheses
    mutate(balanced_par = (cumsum(num_open_par) - cumsum(num_closed_par)) == 0 &amp;
             code != "")
  
}
```


```r
library(gapminder)
library(tidyverse)
```

```
## ── Attaching packages ──────────────────────────── tidyverse 1.2.1 ──
```

```
## ✔ ggplot2 3.2.0     ✔ purrr   0.3.2
## ✔ tibble  2.1.3     ✔ dplyr   0.7.8
## ✔ tidyr   0.8.2     ✔ stringr 1.4.0
## ✔ readr   1.1.1     ✔ forcats 0.3.0
```

```
## Warning: package 'ggplot2' was built under R version 3.5.2
```

```
## Warning: package 'tibble' was built under R version 3.5.2
```

```
## Warning: package 'purrr' was built under R version 3.5.2
```

```
## Warning: package 'stringr' was built under R version 3.5.2
```

```
## ── Conflicts ─────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
```

# Example code


```r
gapminder %&gt;%             # the data  #REVEAL
  filter(year == (2000 + 7)) %&gt;%  # subset 
  ggplot() +              # pipe to ggplot 
  aes(x = gdpPercap) +
  aes(y = lifeExp) +  
  # Describing what follows
  geom_point() + #REVEAL
  aes(color = 
        paste("continent", 
        continent) 
          ) -&gt;  
my_plot 
```



```r
local_code &lt;- "gapminder %&gt;%             # the data  #REVEAL
  filter(year == (2000 + 7)) %&gt;%  # subset 
  ggplot() +              # pipe to ggplot 
  aes(x = gdpPercap) +
  aes(y = lifeExp) +  
  # Describing what follows
  geom_point() + #REVEAL
  aes(color = 
  paste(\"continent\", 
        continent) 
          ) -&gt;  
my_plot "
```


---


```r
knitr:::knit_code$get("the_code")
```

```
##  [1] "gapminder %&gt;%             # the data  #REVEAL"
##  [2] "  filter(year == (2000 + 7)) %&gt;%  # subset "  
##  [3] "  ggplot() +              # pipe to ggplot "  
##  [4] "  aes(x = gdpPercap) +"                       
##  [5] "  aes(y = lifeExp) +  "                       
##  [6] "  # Describing what follows"                  
##  [7] "  geom_point() + #REVEAL"                     
##  [8] "  aes(color = "                               
##  [9] "        paste(\"continent\", "                
## [10] "        continent) "                          
## [11] "          ) -&gt;  "                             
## [12] "my_plot "                                     
## attr(,"chunk_opts")
## attr(,"chunk_opts")$label
## [1] "the_code"
## 
## attr(,"chunk_opts")$eval
## F
```

---

# use parse_code() to pull apart example code


```r
parse_code(knitr:::knit_code$get("the_code")) %&gt;% 
  knitr::kable()
```

```
## Warning: Expected 2 pieces. Missing pieces filled with `NA` in 8 rows [4,
## 5, 7, 8, 9, 10, 11, 12].
```



code                         comment                     user_reveal   connector    num_open_par   num_closed_par  balanced_par 
---------------------------  --------------------------  ------------  ----------  -------------  ---------------  -------------
gapminder                    # the data                  TRUE          %&gt;%                     0                0  TRUE         
filter(year == (2000 + 7))   # subset                    FALSE         %&gt;%                     2                2  TRUE         
ggplot()                     # pipe to ggplot            FALSE         +                       1                1  TRUE         
aes(x = gdpPercap)                                       FALSE         +                       1                1  TRUE         
aes(y = lifeExp)                                         FALSE         +                       1                1  TRUE         
                             # Describing what follows   FALSE                                 0                0  FALSE        
geom_point()                                             TRUE          +                       1                1  TRUE         
aes(color =                                              FALSE                                 1                0  FALSE        
paste("continent",                                       FALSE                                 1                0  FALSE        
continent)                                               FALSE                                 0                1  FALSE        
)                                                        FALSE         -&gt;                      0                1  TRUE         
my_plot                                                  FALSE                                 0                0  TRUE         

```r
parse_code(str_split(local_code, "\n")[[1]])
```

```
## Warning: Expected 2 pieces. Missing pieces filled with `NA` in 8 rows [4,
## 5, 7, 8, 9, 10, 11, 12].
```

```
## # A tibble: 12 x 7
##    code  comment user_reveal connector num_open_par num_closed_par
##    &lt;chr&gt; &lt;chr&gt;   &lt;lgl&gt;       &lt;chr&gt;            &lt;int&gt;          &lt;int&gt;
##  1 "gap… "  # t… TRUE        %&gt;%                  0              0
##  2 "  f… "  # s… FALSE       %&gt;%                  2              2
##  3 "  g… "  # p… FALSE       +                    1              1
##  4 "  a… ""      FALSE       +                    1              1
##  5 "  a… ""      FALSE       +                    1              1
##  6 ""    "  # D… FALSE       ""                   0              0
##  7 "  g… ""      TRUE        +                    1              1
##  8 "  a… ""      FALSE       ""                   1              0
##  9 "  p… ""      FALSE       ""                   1              0
## 10 "   … ""      FALSE       ""                   0              1
## 11 "   … ""      FALSE       -&gt;                   0              1
## 12 my_p… ""      FALSE       ""                   0              0
## # … with 1 more variable: balanced_par &lt;lgl&gt;
```

```r
the_parsed &lt;- parse_code(knitr:::knit_code$get("the_code"))
```

```
## Warning: Expected 2 pieces. Missing pieces filled with `NA` in 8 rows [4,
## 5, 7, 8, 9, 10, 11, 12].
```




```r
break_points &lt;- function(the_parsed_code_df, user_reveal_defined = F) {
  
  parsed &lt;- the_parsed_code_df
  
  if (user_reveal_defined == F) {
    
    breaks &lt;- parsed$balanced_par
    
  } else {
    
    breaks &lt;- parsed$user_reveal
    
  }
  
  (1:length(breaks))[breaks]
  
}

break_points(the_parsed)
```

```
## [1]  1  2  3  4  5  7 11 12
```

```r
break_points(the_parsed) -&gt;
  my_break_points
```




```r
highlighting &lt;- function(the_break_points){
  
  highlight &lt;- list()
  
  for (i in 1:length(the_break_points)) {
    if (i == 1) {  
      highlight[[i]] &lt;- 1:the_break_points[i]
    } else {
      highlight[[i]] &lt;- (the_break_points[i - 1] + 1):the_break_points[i]
    }
  }

  highlight
}

highlighting(my_break_points) 
```

```
## [[1]]
## [1] 1
## 
## [[2]]
## [1] 2
## 
## [[3]]
## [1] 3
## 
## [[4]]
## [1] 4
## 
## [[5]]
## [1] 5
## 
## [[6]]
## [1] 6 7
## 
## [[7]]
## [1]  8  9 10 11
## 
## [[8]]
## [1] 12
```

```r
highlighting(my_break_points) -&gt;
  my_highlighting
```


```r
# reveal lines up to `upto` and highlight lines `highlight`
emi_reveal &lt;- function(name, upto, highlight) {
content &lt;- knitr:::knit_code$get(name)
  content[upto] &lt;- gsub("+", "", content[upto], fixed=T)
  content[highlight] &lt;- paste(content[highlight], "#&lt;&lt;")
  content[1:upto]
} 

emi_reveal("the_code", 4, 4)
```

```
## [1] "gapminder %&gt;%             # the data  #REVEAL"
## [2] "  filter(year == (2000 + 7)) %&gt;%  # subset "  
## [3] "  ggplot() +              # pipe to ggplot "  
## [4] "  aes(x = gdpPercap)  #&lt;&lt;"
```



```r
reveal &lt;- function(chunk_name, upto, highlight) {
  content &lt;- knitr:::knit_code$get(chunk_name)
  parse_code(code = content) %&gt;% 
    mutate(reveal = 1:n() &lt;= upto) %&gt;% 
    filter(reveal) %&gt;% 
    mutate(connector = case_when(1:n() == n() ~ "",
                                 1:n() != n() ~ connector)) %&gt;% 
    mutate(highlight = ifelse(1:n() %in% highlight, "#&lt;&lt;", ""
                              )) %&gt;% 
    mutate(out = paste0(code, "", connector, "", comment, highlight)) %&gt;% 
    select(out) -&gt;
    up_to_result
  up_to_result$out
}
```

# reveal example



```r
reveal("the_code", my_break_points[7], my_highlighting[[7]])
```

```
## Warning: Expected 2 pieces. Missing pieces filled with `NA` in 8 rows [4,
## 5, 7, 8, 9, 10, 11, 12].
```

```
##  [1] "gapminder %&gt;%  # the data"                 
##  [2] "  filter(year == (2000 + 7)) %&gt;%  # subset"
##  [3] "  ggplot() +  # pipe to ggplot"            
##  [4] "  aes(x = gdpPercap) +"                    
##  [5] "  aes(y = lifeExp) +"                      
##  [6] "  # Describing what follows"               
##  [7] "  geom_point() +"                          
##  [8] "  aes(color =#&lt;&lt;"                          
##  [9] "        paste(\"continent\",#&lt;&lt;"           
## [10] "        continent)#&lt;&lt;"                     
## [11] "          ) #&lt;&lt;"
```




```r
partial_knit_chunks &lt;- function(chunk_name, the_break_points, the_highlighting, show_code = T) {
  # Create slide for lines 1:N for each line N in the given chunk
  # break_points &lt;- seq_along(knitr:::knit_code$get(chunk_name)) # original code, breaks for each line
  
  if (show_code == T) {
  partial_knit_steps &lt;- glue::glue(
    "class: split-40",
    "count: false",
    "",
    ".column[.content[",
    "```{r plot_{{chunk_name}}_{{the_break_points}}, eval=FALSE, code=reveal('{{chunk_name}}', {{the_break_points}}, {{the_highlighting}})}",
    "```",
    "]]",
    ".column[.content.center[",
    "```{r output_{{chunk_name}}_{{the_break_points}}, echo=FALSE, code=reveal('{{chunk_name}}', {{the_break_points}}, {{the_highlighting}})}",
    "```",
    "]]",
    .open = "{{", .close = "}}", .sep = "\n"
  )
  glue::glue_collapse(partial_knit_steps, "\n---\n")
  } else {
    
    partial_knit_steps &lt;- glue::glue("```{r output_{{chunk_name}}_{{the_break_points}}, echo=FALSE, code=reveal('{{chunk_name}}', {{the_break_points}}, {{the_highlighting}})}",
    "```",
    .open = "{{", .close = "}}", .sep = "\n"
    )
    glue::glue_collapse(partial_knit_steps, "\n---\n")
    
  }
  
}
```



```r
partial_knit_chunks(chunk_name = "the_code", 
                    the_break_points = my_break_points, 
                    the_highlighting = my_highlighting, 
                    show_code = T)
```

```
## class: split-40
## count: false
## 
## .column[.content[
## ```{r plot_the_code_1, eval=FALSE, code=reveal('the_code', 1, 1)}
## ```
## ]]
## .column[.content.center[
## ```{r output_the_code_1, echo=FALSE, code=reveal('the_code', 1, 1)}
## ```
## ]]
## ---
## class: split-40
## count: false
## 
## .column[.content[
## ```{r plot_the_code_2, eval=FALSE, code=reveal('the_code', 2, 2)}
## ```
## ]]
## .column[.content.center[
## ```{r output_the_code_2, echo=FALSE, code=reveal('the_code', 2, 2)}
## ```
## ]]
## ---
## class: split-40
## count: false
## 
## .column[.content[
## ```{r plot_the_code_3, eval=FALSE, code=reveal('the_code', 3, 3)}
## ```
## ]]
## .column[.content.center[
## ```{r output_the_code_3, echo=FALSE, code=reveal('the_code', 3, 3)}
## ```
## ]]
## ---
## class: split-40
## count: false
## 
## .column[.content[
## ```{r plot_the_code_4, eval=FALSE, code=reveal('the_code', 4, 4)}
## ```
## ]]
## .column[.content.center[
## ```{r output_the_code_4, echo=FALSE, code=reveal('the_code', 4, 4)}
## ```
## ]]
## ---
## class: split-40
## count: false
## 
## .column[.content[
## ```{r plot_the_code_5, eval=FALSE, code=reveal('the_code', 5, 5)}
## ```
## ]]
## .column[.content.center[
## ```{r output_the_code_5, echo=FALSE, code=reveal('the_code', 5, 5)}
## ```
## ]]
## ---
## class: split-40
## count: false
## 
## .column[.content[
## ```{r plot_the_code_7, eval=FALSE, code=reveal('the_code', 7, 6:7)}
## ```
## ]]
## .column[.content.center[
## ```{r output_the_code_7, echo=FALSE, code=reveal('the_code', 7, 6:7)}
## ```
## ]]
## ---
## class: split-40
## count: false
## 
## .column[.content[
## ```{r plot_the_code_11, eval=FALSE, code=reveal('the_code', 11, 8:11)}
## ```
## ]]
## .column[.content.center[
## ```{r output_the_code_11, echo=FALSE, code=reveal('the_code', 11, 8:11)}
## ```
## ]]
## ---
## class: split-40
## count: false
## 
## .column[.content[
## ```{r plot_the_code_12, eval=FALSE, code=reveal('the_code', 12, 12)}
## ```
## ]]
## .column[.content.center[
## ```{r output_the_code_12, echo=FALSE, code=reveal('the_code', 12, 12)}
## ```
## ]]
```


```r
apply_reveal &lt;- function(chunk_name, the_break_points, the_highlighting, show_code){
  paste(knitr::knit(text = partial_knit_chunks(chunk_name, the_break_points, the_highlighting, show_code = T)), collapse = "\n")
}
```


---

class: split-40
count: false

.column[.content[

```r
*gapminder   # the data
```
]]
.column[.content.center[

```
## # A tibble: 1,704 x 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779.
##  2 Afghanistan Asia       1957    30.3  9240934      821.
##  3 Afghanistan Asia       1962    32.0 10267083      853.
##  4 Afghanistan Asia       1967    34.0 11537966      836.
##  5 Afghanistan Asia       1972    36.1 13079460      740.
##  6 Afghanistan Asia       1977    38.4 14880372      786.
##  7 Afghanistan Asia       1982    39.9 12881816      978.
##  8 Afghanistan Asia       1987    40.8 13867957      852.
##  9 Afghanistan Asia       1992    41.7 16317921      649.
## 10 Afghanistan Asia       1997    41.8 22227415      635.
## # … with 1,694 more rows
```
]]
---
class: split-40
count: false

.column[.content[

```r
gapminder %&gt;%  # the data
* filter(year == (2000 + 7))   # subset
```
]]
.column[.content.center[

```
## # A tibble: 142 x 6
##    country     continent  year lifeExp       pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;     &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       2007    43.8  31889923      975.
##  2 Albania     Europe     2007    76.4   3600523     5937.
##  3 Algeria     Africa     2007    72.3  33333216     6223.
##  4 Angola      Africa     2007    42.7  12420476     4797.
##  5 Argentina   Americas   2007    75.3  40301927    12779.
##  6 Australia   Oceania    2007    81.2  20434176    34435.
##  7 Austria     Europe     2007    79.8   8199783    36126.
##  8 Bahrain     Asia       2007    75.6    708573    29796.
##  9 Bangladesh  Asia       2007    64.1 150448339     1391.
## 10 Belgium     Europe     2007    79.4  10392226    33693.
## # … with 132 more rows
```
]]
---
class: split-40
count: false

.column[.content[

```r
gapminder %&gt;%  # the data
  filter(year == (2000 + 7)) %&gt;%  # subset
* ggplot()   # pipe to ggplot
```
]]
.column[.content.center[
![](code_parsing_w_regex_test_files/figure-html/output_the_code_3-1.png)&lt;!-- --&gt;
]]
---
class: split-40
count: false

.column[.content[

```r
gapminder %&gt;%  # the data
  filter(year == (2000 + 7)) %&gt;%  # subset
  ggplot() +  # pipe to ggplot
* aes(x = gdpPercap)
```
]]
.column[.content.center[
![](code_parsing_w_regex_test_files/figure-html/output_the_code_4-1.png)&lt;!-- --&gt;
]]
---
class: split-40
count: false

.column[.content[

```r
gapminder %&gt;%  # the data
  filter(year == (2000 + 7)) %&gt;%  # subset
  ggplot() +  # pipe to ggplot
  aes(x = gdpPercap) +
* aes(y = lifeExp)
```
]]
.column[.content.center[
![](code_parsing_w_regex_test_files/figure-html/output_the_code_5-1.png)&lt;!-- --&gt;
]]
---
class: split-40
count: false

.column[.content[

```r
gapminder %&gt;%  # the data
  filter(year == (2000 + 7)) %&gt;%  # subset
  ggplot() +  # pipe to ggplot
  aes(x = gdpPercap) +
  aes(y = lifeExp) +
* # Describing what follows
* geom_point()
```
]]
.column[.content.center[
![](code_parsing_w_regex_test_files/figure-html/output_the_code_7-1.png)&lt;!-- --&gt;
]]
---
class: split-40
count: false

.column[.content[

```r
gapminder %&gt;%  # the data
  filter(year == (2000 + 7)) %&gt;%  # subset
  ggplot() +  # pipe to ggplot
  aes(x = gdpPercap) +
  aes(y = lifeExp) +
  # Describing what follows
  geom_point() +
* aes(color =
*       paste("continent",
*       continent)
*         )
```
]]
.column[.content.center[
![](code_parsing_w_regex_test_files/figure-html/output_the_code_11-1.png)&lt;!-- --&gt;
]]
---
class: split-40
count: false

.column[.content[

```r
gapminder %&gt;%  # the data
  filter(year == (2000 + 7)) %&gt;%  # subset
  ggplot() +  # pipe to ggplot
  aes(x = gdpPercap) +
  aes(y = lifeExp) +
  # Describing what follows
  geom_point() +
  aes(color =
        paste("continent",
        continent)
          ) -&gt;
*my_plot
```
]]
.column[.content.center[

]]





&lt;style type="text/css"&gt;
.remark-code{line-height: 1.5; font-size: 60%}
&lt;/style&gt;
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:10",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
